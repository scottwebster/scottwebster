<script src="{{ "/js/vendor/leaflet.js" | prepend: site.baseurl }}"></script>
<script src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
<link rel="stylesheet" href="{{ "/css/leaflet.css" | prepend: site.baseurl }}">
<div id="map"></div>
<script>
//<![CDATA[
function onEachFeature(feature, layer) {
  // does this feature have a property named popupContent?
  if (feature.properties && feature.properties.name) {
      var content = '<p><strong><a href="'+feature.properties.url+'">'+feature.properties.name+'</a></strong></p>\n<p class="subdue"><em>'+feature.properties.date+'</em><br>'+feature.properties.content+'<br><a href="'+feature.properties.url+'">&raquo; Read more</a></p>';
      layer.bindPopup(content);
  }
};

var map = L.map('map',{scrollWheelZoom: false});

L.Icon.Default.imagePath = '{{ "/img/leaflet/" | prepend: site.baseurl }}';
var watercolor = new L.StamenTileLayer("watercolor", {
  attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'
});

// Create posts
var foo = L.geoJson();
var contentGeoJson = [{"type":"FeatureCollection",
                        "features":[{% for post in map_posts %}{"type":"Feature",
                        "properties":{
                          "name": "{{post.title}}",
                          "marker-color": "#2A2B26",
                          "date": "{{post.date | date: "%-d %B %Y" }}",
                          "url": "{{ post.url | prepend: site.baseurl }}",
                          "content": "{{ post.content | strip_html | truncatewords: 50}}",
                          },
                        "geometry":{
                          "type":"Point",
                          "coordinates":[{{post.location}}]
                          }
                        }{% if forloop.last == false %},{% endif %}{% endfor %}]}];
// Create track
var track = L.polyline([{% for post in map_posts %} L.GeoJSON.coordsToLatLng([{{post.location}}], true){% if forloop.last == false %},{% endif %}{% endfor %}], {color: 'red', opacity: 0.8});
var geoLayer = L.geoJson(contentGeoJson, {onEachFeature: onEachFeature});
// Display layer
map.addLayer(watercolor);
map.addLayer(geoLayer);
map.addLayer(track);
map.fitBounds(geoLayer.getBounds());
map.setZoom(3);
//]]>
</script>
